name: Update Top Contributors

on:
  schedule:
    - cron: '0 6 * * 0'  # Weekly on Sunday at 6 AM UTC
  workflow_dispatch:

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Top Contributors with GraphQL
        env:
          ORG_NAME: "ObsidianHonorCoders"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GraphQL query for comprehensive activity data
          GRAPHQL_QUERY='
          query($org: String!, $since: GitTimestamp!) {
            organization(login: $org) {
              repositories(first: 100) {
                nodes {
                  name
                  defaultBranchRef {
                    target {
                      ... on Commit {
                        history(since: $since) {
                          totalCount
                          authors {
                            edges {
                              node {
                                user {
                                  login
                                  avatarUrl
                                  url
                                }
                              }
                              count
                            }
                          }
                        }
                      }
                    }
                  }
                  pullRequests(states: MERGED, first: 100, orderBy: {field: UPDATED_AT, direction: DESC}) {
                    nodes {
                      author {
                        login
                        avatarUrl
                        url
                      }
                    }
                  }
                }
              }
            }
          }'
          
          # Execute GraphQL query
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"$GRAPHQL_QUERY\", \"variables\": {\"org\": \"$ORG_NAME\", \"since\": \"$(date -d '90 days ago' -I)\"}}" \
            https://api.github.com/graphql)
          
          # Process data and generate HTML
          echo "$RESPONSE" | jq -r '
          .data.organization.repositories.nodes[] |
          .defaultBranchRef.target.history.authors.edges[] |
          {
            login: .node.user.login,
            avatar: .node.user.avatarUrl,
            profile: .node.user.url,
            commits: .count
          }' | \
          jq -s 'group_by(.login) | 
          map({
            login: .[0].login,
            avatar: .[0].avatar,
            profile: .[0].profile,
            contributions: map(.commits) | add
          }) | 
          sort_by(.contributions) | 
          reverse | 
          .[:10]' | \
          jq -r '.[] | 
          "<a href=\"\(.profile)\" title=\"\(.login) - \(.contributions) contributions\">" +
          "<img src=\"\(.avatar)\" width=\"80px\" alt=\"\(.login)\" " +
          "style=\"border-radius:50%; margin:5px; border:2px solid #f0ad4e;\"></a>"
          ' > contributors_section.html

          # Define markers
          START_MARKER="<!--contributors-start-->"
          END_MARKER="<!--contributors-end-->"
          TARGET_FILE="profile/README.md"

          # Replace content between markers
          CONTENT=$(cat contributors_section.html)
          sed -i "/$START_MARKER/,/$END_MARKER/{ 
            /$START_MARKER/!{ 
              /$END_MARKER/!d
            }
          }" "$TARGET_FILE"
          sed -i "/$START_MARKER/a \\$CONTENT" "$TARGET_FILE"

      - name: Commit and Push
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add profile/README.md
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "[doc] Update top contributors"
            git push
          fi
