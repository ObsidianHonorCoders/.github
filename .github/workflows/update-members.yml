name: Update Organization Members
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Members and Update README
        env:
          ORG_NAME: "ObsidianHonorCoders"
        run: |
          # 1. Fetch public members
          MEMBERS=$(curl -s "https://api.github.com/orgs/$ORG_NAME/members" | jq -r '.[].login')

          # 2. Build the HTML string
          MEMBER_HTML=""
          for member in $MEMBERS; do
            MEMBER_HTML+='<a href="https://github.com/'$member'"><img src="https://github.com/'$member'.png" width="60px" alt="'$member'" style="border-radius:50%; margin:2px;"></a> '
          done

          # 3. Define the markers and file
          START_MARKER="<!--members-start-->"
          END_MARKER="<!--members-end-->"
          TARGET_FILE="profile/README.md"

          # 4. Inject the HTML using the variables
          sed -i "/$START_MARKER/,/$END_MARKER/{ /$START_MARKER/!{ /$END_MARKER/!d; }; }" "$TARGET_FILE"
          sed -i "/$START_MARKER/a $MEMBER_HTML" "$TARGET_FILE"

      - name: Commit and Push
        run: |
          # 1. Configure the identity
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 2. Stage the specific file
          git add profile/README.md

          # 3. Only commit if something actually changed
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "[doc] Update OHC organization members"
            git push
          fi
